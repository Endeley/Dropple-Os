N1.1 — Ownership Membership Bootstrap
Formal Invariant Specification

Invariant Name

Persistent Document Ownership Invariant

Invariant Statement (Authoritative)

Every persisted document that exists on the server MUST have exactly one owner entry in documentMembers, and that entry MUST be created atomically at the moment the document first becomes persisted.

This invariant must hold at all times, independent of:

- editor state
- sharing UI
- collaboration phase
- analytics
- viewer/editor mode

If this invariant is violated, collaboration semantics are undefined.

Why this invariant exists

The system relies on role-derived permissions for:

- Sharing UI visibility
- Invite authorization
- Viewer/editor gating
- Future presence and collaboration features

Without guaranteed ownership membership:

- getUserRole(docId) becomes unreliable
- Sharing UI can silently fail
- Presence data can exist without authority
- Later phases (N2/N3) become unsafe

This invariant converts "implicit ownership" into explicit, enforceable state.

Scope

Applies to:

- All documents persisted to Convex
- All server-side document creation paths
- All publish / save flows that materialize a document server-side

Does NOT apply to:

- Unsaved local documents
- Ephemeral drafts
- Viewer-only snapshots
- Gallery items (ownership is indirect)

Canonical Source of Truth

Table: documentMembers

{
  docId: string,
  userId: string,
  role: 'owner',
  createdAt: number
}

Exactly one row with role === 'owner' must exist per persisted document.

Enforcement Rules

R1 — Atomic creation

When a document is first persisted to the server:

- The document record
- AND the owner membership row

MUST be created in the same logical operation.

No intermediate state is allowed where:

- A document exists without an owner
- An owner exists without a document

R2 — Single owner guarantee

For any given docId:

- There MUST be exactly one owner
- Zero owners is invalid
- Multiple owners is invalid

Future role changes do not apply to owners in N1.

R3 — Owner identity

The owner MUST be:

- The authenticated user who initiated persistence
- Derived from ctx.auth.getUserIdentity().subject
- Never inferred from client state

R4 — Idempotency

If a persistence flow is retried:

- Owner membership creation must be idempotent
- Duplicate owner rows must not be created

R5 — Read-time assumption

All permission logic (getUserRole) is allowed to assume:

"If docId exists, ownership membership exists."

No defensive fallback logic should be required elsewhere.

Non-Goals (Explicit)

This invariant does NOT introduce:

- Collaboration UI
- Live editing
- Multiple owners
- Role transfer
- Team ownership
- Server-side editing

It exists purely to stabilize authority.

Failure Modes (and why they are unacceptable)

Failure: Document without owner
Why it breaks the system: Sharing and permissions fail silently

Failure: Owner added later
Why it breaks the system: Race conditions, partial state

Failure: Client-side owner inference
Why it breaks the system: Security vulnerability

Failure: Multiple owners
Why it breaks the system: Undefined authority

Failure: Best-effort owner creation
Why it breaks the system: N2/N3 unsafe

Any of the above must be treated as a blocking bug.

Implementation Constraints

Must live in the server persistence layer.
Must not rely on UI code.
Must not be conditional on collaboration features.
Must execute even if sharing UI is never opened.

Verification Checklist — N1.1 Completion Gate

Schema & Data Integrity

- documentMembers table exists
- Owner rows use role 'owner'
- No persisted document exists without an owner row
- No persisted document has more than one owner row

Persistence Flow

- Owner membership is created at first persistence
- Persistence is atomic (no partial states)
- Retry does not duplicate owner membership
- Owner identity comes from server auth context

Permission Resolution

- getUserRole(docId) always resolves for persisted docs
- Role queries are never skipped for valid docId
- Sharing UI relies on role, not heuristics
- Viewer/editor gating is deterministic

UX Validation

- Owner always sees Sharing panel for saved docs
- Editors never see Sharing panel
- Viewers never see Sharing panel
- Unsaved docs still hide sharing (correct)

Architectural Readiness

- Presence features can rely on role data
- No future N2/N3 code needs to "fix ownership"
- Collaboration layers do not need defensive checks
